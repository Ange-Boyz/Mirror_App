<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Life Mirror ‚Äî Prise de conscience</title>

  <!-- PDF libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* ---------- Theme & reset (mobile-first) ---------- */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap');
    :root{
      --bg-0:#061226; --bg-1:#0b1730; --card:#0f2238;
      --muted:#96a3bf; --text:#e6eef6; --accent:#2b8eff; --accent-2:#60a5fa; --success:#10b981;
      --glass: rgba(255,255,255,0.03); --focus: rgba(43,142,255,0.14);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Inter',system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;color:var(--text);background:linear-gradient(180deg,var(--bg-0),var(--bg-1));-webkit-font-smoothing:antialiased}
    a{color:inherit}

    /* Container */
    .container{max-width:1080px;margin:18px auto;padding:16px;display:flex;flex-direction:column;gap:18px;min-height:calc(100vh - 36px)}

    /* Header */
    .header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px;border-radius:12px;background:linear-gradient(180deg,var(--card), rgba(255,255,255,0.02));border:1px solid var(--glass)}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:grid;place-items:center;box-shadow:0 8px 28px rgba(43,142,255,0.12)}
    .logo svg{width:24px;height:24px;fill:white}
    h1{font-size:1.05rem;margin:0}
    p.subtitle{margin:0;color:var(--muted);font-size:0.9rem}

    .lang-toggle{display:flex;gap:6px}
    .lang-toggle button{padding:8px 10px;border-radius:8px;background:transparent;border:1px solid transparent;color:var(--muted);cursor:pointer;font-weight:700}
    .lang-toggle button.active{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white}

    /* Main layout */
    .main{display:flex;flex-direction:column;gap:16px}

    /* Sidebar (stacked on mobile) */
    .sidebar{display:flex;flex-direction:column;gap:12px}
    .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:14px;border-radius:12px;border:1px solid var(--glass)}
    .field{display:flex;flex-direction:column;gap:8px}
    label{font-size:0.85rem;color:var(--muted);font-weight:600}
    input[type=text],input[type=number],textarea,select{padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);outline:none;font-size:0.95rem}
    textarea{min-height:88px;resize:vertical}
    input:focus,textarea:focus{box-shadow:0 8px 20px var(--focus);border-color:var(--accent)}

    /* Steps (horizontal on mobile) */
    .steps{display:flex;gap:8px;overflow:auto;padding:6px 2px}
    .step{min-width:40px;height:40px;border-radius:10px;background:transparent;border:1px solid var(--glass);display:grid;place-items:center;color:var(--muted);font-weight:700;cursor:pointer}
    .step.active{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;transform:translateY(-3px);box-shadow:0 10px 30px rgba(43,142,255,0.12)}
    .step.completed{background:linear-gradient(90deg,var(--success),#059669);color:white}

    /* Question area */
    .question{padding:6px 0}
    .question h3{font-size:1rem;margin:0 0 10px 0;color:var(--text);line-height:1.35}
    .options-grid{display:grid;grid-template-columns:1fr;gap:8px}
    .option-btn{padding:12px;border-radius:10px;border:1px solid var(--glass);background:transparent;color:var(--text);font-weight:700;cursor:pointer}
    .option-btn.active{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;box-shadow:0 8px 20px rgba(43,142,255,0.12);transform:translateY(-2px)}

    /* Controls */
    .controls{display:flex;gap:10px;margin-top:12px}
    .btn{flex:1;padding:12px;border-radius:12px;border:0;font-weight:800;cursor:pointer}
    .btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white}
    .btn-ghost{background:transparent;border:1px solid var(--glass);color:var(--text)}

    /* Life grid & stats */
    .life-visual{display:flex;flex-direction:column;gap:10px}
    .grid{display:grid;grid-template-columns:repeat(26, 1fr);gap:3px}
    .cell{aspect-ratio:1/1;border-radius:3px;background:var(--glass);transition:all .18s}
    .cell.past{background:linear-gradient(135deg,#123b7a,#083066);box-shadow:0 0 6px rgba(30,64,175,0.16)}
    .cell.now{background:linear-gradient(90deg,var(--accent),var(--accent-2));box-shadow:0 0 10px rgba(43,142,255,0.24);animation:pulse 2.2s infinite}
    @keyframes pulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.06);opacity:.95}}

    .stats{padding:12px;border-radius:10px;background:linear-gradient(90deg,var(--accent),#2563eb);color:white;text-align:center}
    .stats .value{font-size:1.6rem;font-weight:800}
    .stats .label{font-size:.9rem;opacity:.95}

    /* Report */
    .report{display:none;flex-direction:column;gap:12px}
    .report .card{padding:14px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border-radius:12px;border:1px solid var(--glass)}
    .report h2{margin:0 0 8px 0}
    .report p{margin:8px 0;color:var(--muted);line-height:1.6}

    footer{color:var(--muted);font-size:12px;text-align:center;padding:8px}

    /* Larger screens */
    @media(min-width:880px){
      .main{flex-direction:row;align-items:flex-start;gap:20px}
      .sidebar{width:320px;flex-shrink:0}
      .content{flex:1}
      .grid{grid-template-columns:repeat(52,1fr)}
    }

    @media(max-width:420px){
      .step{min-width:36px;height:36px}
      .grid{grid-template-columns:repeat(20,1fr)}
      .option-btn{padding:10px}
      .btn{padding:10px}
    }
  </style>
</head>
<body>
  <div class="container" role="application" aria-live="polite">
    <!-- Header -->
    <header class="header" role="banner">
      <div class="brand">
        <div class="logo" aria-hidden>
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2a10 10 0 100 20 10 10 0 000-20zm0 3a7 7 0 110 14 7 7 0 010-14z"/></svg>
        </div>
        <div>
          <h1>Life Mirror</h1>
          <p class="subtitle">Un outil pour prendre conscience de ton temps</p>
        </div>
      </div>

      <div class="lang-toggle" role="radiogroup" aria-label="Choisir la langue">
        <button id="langFr" class="active" role="radio" aria-checked="true">FR</button>
        <button id="langEn" role="radio" aria-checked="false">EN</button>
      </div>
    </header>

    <!-- Main -->
    <main class="main" role="main">
      <!-- Sidebar (mobile stacked) -->
      <aside class="sidebar panel" aria-label="Param√®tres utilisateur">
        <div class="field">
          <label for="nameInput" id="lblName">Nom</label>
          <input id="nameInput" type="text" placeholder="Ex: Ange" inputmode="text" />
        </div>

        <div class="field">
          <label for="ageInput" id="lblAge">√Çge actuel</label>
          <input id="ageInput" type="number" min="0" max="130" value="20" inputmode="numeric" />
        </div>

        <div class="field">
          <label for="deathInput" id="lblDeath">√Çge estim√© pour mourir</label>
          <input id="deathInput" type="number" min="1" max="140" value="80" inputmode="numeric" />
        </div>

        <div class="stats" aria-live="polite">
          <div class="value" id="percentView">0%</div>
          <div class="label" id="percentLabel">de ta vie v√©cue</div>
          <div class="label" id="weeksLeft">0 semaines restantes</div>
          <div class="label" id="totalCases" style="margin-top:6px;font-size:12px;opacity:0.9">Total cases: 0</div>
        </div>

        <div class="panel" style="margin-top:6px">
          <div style="font-size:13px;color:var(--muted);margin-bottom:8px">Aper√ßu</div>
          <div class="life-visual">
            <div class="grid" id="previewGrid" aria-hidden="true"></div>
          </div>
        </div>
      </aside>

      <!-- Content -->
      <section class="content panel" aria-labelledby="questionTitle">
        <div class="steps" id="steps" role="tablist" aria-label="√âtapes"></div>

        <div id="questionArea" aria-live="polite" style="margin-top:12px"></div>

        <div class="controls" style="margin-top:12px">
          <button id="prevBtn" class="btn btn-ghost" aria-label="Pr√©c√©dent" disabled>‚Üê <span id="prevText">Pr√©c√©dent</span></button>
          <button id="nextBtn" class="btn btn-primary" aria-label="Suivant"><span id="nextText">Suivant</span> ‚Üí</button>
        </div>
      </section>
    </main>

    <!-- Report -->
    <section class="report" id="reportSection" aria-live="polite">
      <div class="card" id="reportCard" style="display:none">
        <h2 id="reportTitle">Rapport & Conseils</h2>
        <div id="reportContent"></div>
        <div id="adviceBox" class="panel" style="margin-top:12px;display:none"></div>

        <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
          <button id="downloadPDF" class="btn btn-primary">üìÑ T√©l√©charger PDF</button>
          <button id="downloadJSON" class="btn btn-ghost">üíæ T√©l√©charger JSON</button>
          <button id="restartBtn" class="btn btn-ghost">üîÑ Recommencer</button>
        </div>
      </div>
    </section>

    <footer><small>Life Mirror ‚Ä¢ Tes r√©ponses sont stock√©es localement dans ton navigateur</small></footer>
  </div>

  <script>
  (function(){
    // Questions (Option A ‚Äî 10 questions)
    const QUESTIONS = {
      fr: [
        {id:'q_name', title:"Quel est ton nom ?", type:'text', placeholder:'Ex: Ange'},
        {id:'q_age', title:"Quel √¢ge as-tu actuellement ?", type:'number', placeholder:'Ex: 20'},
        {id:'q_death', title:"√Ä quel √¢ge penses-tu ou aimerais-tu mourir ?", type:'number', placeholder:'Ex: 80'},
        {id:'q_happy', title:"Qu'est-ce qui te rend vraiment heureux dans la vie ?", type:'textarea', placeholder:'Ex: Passer du temps avec ma famille, cr√©er...'},
        {id:'q_fear', title:"Qu'est-ce qui te stresse ou te fait peur ?", type:'textarea', placeholder:'Ex: Perdre un proche, ne pas r√©ussir...'},
        {id:'q_dream', title:"Quel est ton plus grand r√™ve non encore r√©alis√© ?", type:'textarea', placeholder:'Ex: Lancer un produit...'},
        {id:'q_regret', title:"Quelle est la plus grande chose que tu regrettes ?", type:'textarea', placeholder:'Ex: Ne pas avoir essay√©...'},
        {id:'q_people', title:"Qui sont les personnes les plus importantes pour toi ?", type:'text', placeholder:'Ex: Famille, Alice...'},
        {id:'q_change', title:"Qu'aimerais-tu changer dans ta vie aujourd‚Äôhui ?", type:'textarea', placeholder:'Ex: Me lever plus t√¥t...'},
        {id:'q_message', title:"Si tu mourais demain, que voudrais-tu qu'on se souvienne de toi ?", type:'text', placeholder:'Ex: J\'ai toujours aid√© les autres...'}
      ],
      en: [
        {id:'q_name', title:"What is your name?", type:'text', placeholder:'Ex: John'},
        {id:'q_age', title:"How old are you now?", type:'number', placeholder:'Ex: 20'},
        {id:'q_death', title:"At what age do you think or wish to die?", type:'number', placeholder:'Ex: 80'},
        {id:'q_happy', title:"What truly makes you happy in life?", type:'textarea', placeholder:'E.g. Spending time with family, creating...'},
        {id:'q_fear', title:"What stresses or scares you the most?", type:'textarea', placeholder:'E.g. Losing a loved one, failing...'},
        {id:'q_dream', title:"What is your biggest dream not yet achieved?", type:'textarea', placeholder:'E.g. Launch a product...'},
        {id:'q_regret', title:"What is your biggest regret?", type:'textarea', placeholder:'E.g. Not having tried...'},
        {id:'q_people', title:"Who are the most important people in your life?", type:'text', placeholder:'E.g. Family, Alice...'},
        {id:'q_change', title:"What would you like to change in your life today?", type:'textarea', placeholder:'E.g. Wake up earlier...'},
        {id:'q_message', title:"If you died tomorrow, what would you like to be remembered for?", type:'text', placeholder:'E.g. I always helped others...'}
      ]
    };

    // state
    let lang = 'fr';
    let index = 0;
    const answers = {}; // store by id

    // DOM refs
    const $ = id => document.getElementById(id);
    const stepsEl = $('steps');
    const questionArea = $('questionArea');
    const prevBtn = $('prevBtn');
    const nextBtn = $('nextBtn');
    const nameInput = $('nameInput'), ageInput = $('ageInput'), deathInput = $('deathInput');
    const previewGrid = $('previewGrid'), percentView = $('percentView'), weeksLeft = $('weeksLeft'), totalCases = $('totalCases');
    const reportCard = $('reportCard'), reportContent = $('reportContent'), adviceBox = $('adviceBox');
    const reportSection = $('reportSection');
    const downloadPDF = $('downloadPDF'), downloadJSON = $('downloadJSON'), restartBtn = $('restartBtn');

    // language toggle
    $('langFr').addEventListener('click', ()=>setLang('fr'));
    $('langEn').addEventListener('click', ()=>setLang('en'));

    function setLang(l){
      lang = l;
      $('langFr').classList.toggle('active', l==='fr');
      $('langEn').classList.toggle('active', l==='en');
      renderSteps();
      renderQuestion();
      updatePreview();
      localizeStatic();
    }

    function localizeStatic(){
      const fr = lang==='fr';
      $('prevText').textContent = fr? 'Pr√©c√©dent':'Previous';
      $('nextText').textContent = fr? 'Suivant':'Next';
      $('lblName').textContent = fr? 'Nom':'Name';
      $('lblAge').textContent = fr? '√Çge actuel':'Your age';
      $('lblDeath').textContent = fr? '√Çge estim√© pour mourir':'Expected age of death';
      $('percentLabel').textContent = fr? 'de ta vie v√©cue':'of your life lived';
      $('reportTitle').textContent = fr? 'Rapport & Conseils':'Report & Advice';
      $('downloadPDF').textContent = fr? 'üìÑ T√©l√©charger PDF':'üìÑ Download PDF';
      $('downloadJSON').textContent = fr? 'üíæ T√©l√©charger JSON':'üíæ Download JSON';
      $('restartBtn').textContent = fr? 'üîÑ Recommencer':'üîÑ Restart';
    }

    // build steps
    function renderSteps(){
      stepsEl.innerHTML = '';
      const qs = QUESTIONS[lang];
      qs.forEach((q,i)=>{
        const btn = document.createElement('button');
        btn.className = 'step' + (i===index ? ' active' : '') + (answers[q.id] ? ' completed' : '');
        btn.type = 'button';
        btn.textContent = answers[q.id] ? '‚úì' : (i+1);
        btn.addEventListener('click', ()=>{ saveCurrent(); index = i; renderQuestion(); updatePreview(); });
        stepsEl.appendChild(btn);
      });
    }

    // render current question
    function renderQuestion(){
      questionArea.innerHTML = '';
      const q = QUESTIONS[lang][index];
      const wrapper = document.createElement('div');
      wrapper.className = 'question';

      const title = document.createElement('h3');
      title.id = 'questionTitle';
      title.textContent = q.title;
      wrapper.appendChild(title);

      let input;
      if(q.type === 'textarea'){
        input = document.createElement('textarea');
        input.rows = 5;
      } else {
        input = document.createElement('input');
        input.type = q.type === 'number' ? 'number' : 'text';
        if(q.type === 'number'){ input.min = 0; }
      }
      input.id = 'currentInput';
      input.placeholder = q.placeholder || '';
      input.value = answers[q.id] || '';
      input.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter' && input.tagName !== 'TEXTAREA'){ e.preventDefault(); nextBtn.click(); }
      });
      wrapper.appendChild(input);

      // hint: show sample for age/death fields (synchronize sidebar)
      if(q.id === 'q_name'){ input.addEventListener('input', e => nameInput.value = e.target.value); nameInput.addEventListener('input', e => input.value = e.target.value); }
      if(q.id === 'q_age'){ input.addEventListener('input', e => ageInput.value = e.target.value); ageInput.addEventListener('input', e => input.value = e.target.value); }
      if(q.id === 'q_death'){ input.addEventListener('input', e => deathInput.value = e.target.value); deathInput.addEventListener('input', e => input.value = e.target.value); }

      questionArea.appendChild(wrapper);

      // update controls and steps UI
      renderSteps();
      prevBtn.disabled = index === 0;
      if(index === QUESTIONS[lang].length - 1){
        nextBtn.innerHTML = lang==='fr'? 'Terminer ‚úì' : 'Finish ‚úì';
      } else {
        nextBtn.innerHTML = (lang==='fr'? 'Suivant ‚Üí' : 'Next ‚Üí');
      }
      // focus
      setTimeout(()=>{ input.focus(); },50);
    }

    function saveCurrent(){
      const q = QUESTIONS[lang][index];
      const cur = document.getElementById('currentInput');
      if(!cur) return;
      const val = cur.value && cur.value.trim ? cur.value.trim() : cur.value;
      if(val !== '') answers[q.id] = val;
      else delete answers[q.id];
      renderSteps();
    }

    // prev/next
    prevBtn.addEventListener('click', ()=>{ saveCurrent(); if(index>0){ index--; renderQuestion(); updatePreview(); } });
    nextBtn.addEventListener('click', ()=>{ 
      saveCurrent();
      if(index < QUESTIONS[lang].length - 1){ index++; renderQuestion(); updatePreview(); } else { finish(); }
    });

    // preview grid / stats
    function updatePreview(){
      const age = parseInt(ageInput.value) || parseInt(answers['q_age']) || 0;
      const death = parseInt(deathInput.value) || parseInt(answers['q_death']) || 80;
      const total = Math.max(1, death) * 52;
      const lived = Math.max(0, age) * 52;

      // limit for DOM performance
      const maxCells = (window.innerWidth < 480) ? Math.min(total, 26*2) : Math.min(total, 52*2);
      const step = Math.max(1, Math.ceil(total / maxCells));

      previewGrid.innerHTML = '';
      for(let i=0;i<total;i+=step){
        const d = document.createElement('div');
        d.className = 'cell';
        if(i < lived) d.classList.add('past');
        if(i >= lived && i < lived + step) d.classList.add('now');
        previewGrid.appendChild(d);
      }

      const percent = Math.round((lived/total) * 100);
      percentView.textContent = percent + '%';
      weeksLeft.textContent = Math.max(0, total - lived) + (lang==='fr' ? ' semaines restantes' : ' weeks remaining');
      totalCases.textContent = (lang==='fr' ? 'Total cases: ' : 'Total cases: ') + total;
    }

    // wire sidebar changes to preview & questions
    ageInput.addEventListener('input', updatePreview);
    deathInput.addEventListener('input', updatePreview);
    nameInput.addEventListener('input', ()=>{ /* sync when user types in sidebar */ });

    // finish -> analysis + show report
    function finish(){
      saveCurrent();

      // Prepare data (prefer sidebar values when present)
      const name = nameInput.value || answers['q_name'] || (lang==='fr' ? 'Ami' : 'Friend');
      const age = parseInt(ageInput.value) || parseInt(answers['q_age']) || 0;
      const death = parseInt(deathInput.value) || parseInt(answers['q_death']) || 80;
      const total = Math.max(1, death) * 52;
      const lived = Math.max(0, age) * 52;
      const yearsLeft = Math.max(0, death - age);
      const percent = Math.round((lived/total) * 100);

      // Gather answers (safe defaults)
      const happy = answers['q_happy'] || (lang==='fr'?'Non pr√©cis√©':'Not specified');
      const fear = answers['q_fear'] || (lang==='fr'?'Non pr√©cis√©':'Not specified');
      const dream = answers['q_dream'] || (lang==='fr'?'Non pr√©cis√©':'Not specified');
      const regret = answers['q_regret'] || (lang==='fr'?'Non pr√©cis√©':'Not specified');
      const people = answers['q_people'] || (lang==='fr'?'Non pr√©cis√©':'Not specified');
      const change = answers['q_change'] || (lang==='fr'?'Non pr√©cis√©':'Not specified');
      const message = answers['q_message'] || (lang==='fr'?'Non pr√©cis√©':'Not specified');

      // Build analysis text (some simple heuristic rules to create personalization)
      let tone = '';
      if(percent >= 70) tone = lang==='fr'? "Tu as d√©j√† v√©cu une grande partie de ta vie pr√©vue ‚Äî chaque semaine compte." : "You've already lived a large portion of your expected life ‚Äî each week counts.";
      else if(percent >= 35) tone = lang==='fr'? "Tu as encore du temps important ‚Äî il est temps d'agir intentionnellement." : "You still have significant time ‚Äî it's time to act intentionally.";
      else tone = lang==='fr'? "Tu es encore au d√©but ‚Äî utilise ce capital temps pour b√¢tir ce qui compte." : "You're still early ‚Äî use this time capital to build what matters.";

      // Actionable steps (tailored)
      const actions = [];
      if(dream && dream !== 'Non pr√©cis√©' && dream !== 'Not specified') actions.push(lang==='fr'? `√âcris le premier micro-pas pour ton r√™ve : ${dream}` : `Write the first micro-step for your dream: ${dream}`);
      if(change && change !== 'Non pr√©cis√©' && change !== 'Not specified') actions.push(lang==='fr'? `Commence par : ${change}` : `Start with: ${change}`);
      if(!actions.length) actions.push(lang==='fr'? 'Choisis une habitude simple : marche 20 min / √©cris 10 min.' : 'Pick a small habit: walk 20 min / write 10 min.');

      // Compose report HTML
      const frReport = `
        <div class="card">
          <strong>${lang==='fr'? 'Rapport de vie pour' : 'Life report for'} ${name}</strong>
          <p style="margin-top:8px;color:var(--muted)">${lang==='fr'? 'Semaines v√©cues :' : 'Weeks lived:'} <strong>${lived}</strong> ‚Äî ${percent}%</p>
          <p style="margin-top:6px;color:var(--muted)">${lang==='fr'? 'Semaines totales (cases) :' : 'Total weeks (cases):'} <strong>${total}</strong></p>

          <h3 style="margin-top:12px">${lang==='fr'? 'Analyse' : 'Analysis'}</h3>
          <p style="color:var(--muted)">${tone}</p>

          <h4 style="margin-top:10px">${lang==='fr'? 'D√©tails de tes r√©ponses' : 'Your answers'}</h4>
          <p><strong>${lang==='fr'? 'Ce qui te rend heureux' : 'What makes you happy'}</strong>: ${happy}</p>
          <p><strong>${lang==='fr'? 'Tes peurs/stress' : 'Your fears/stress'}</strong>: ${fear}</p>
          <p><strong>${lang==='fr'? 'R√™ve principal' : 'Main dream'}</strong>: ${dream}</p>
          <p><strong>${lang==='fr'? 'Regret' : 'Regret'}</strong>: ${regret}</p>
          <p><strong>${lang==='fr'? 'Personnes importantes' : 'Important people'}</strong>: ${people}</p>
          <p><strong>${lang==='fr'? 'Changement voulu' : 'Wanted change'}</strong>: ${change}</p>

          <h4 style="margin-top:12px">${lang==='fr'? 'Actions recommand√©es' : 'Recommended actions'}</h4>
          <ul>
            ${actions.map(a=>`<li style="margin-bottom:8px">${a}</li>`).join('')}
            <li style="margin-bottom:8px">${lang==='fr'? 'R√©serve 30 minutes cette semaine pour planifier 1 an / 5 ans.' : 'Reserve 30 minutes this week to plan 1 year / 5 years.'}</li>
          </ul>

          <h4 style="margin-top:12px">${lang==='fr'? 'Message final' : 'Final message'}</h4>
          <p style="font-style:italic">${message}</p>
        </div>
      `;

      // Render report
      reportContent.innerHTML = frReport;
      adviceBox.style.display = 'block';
      adviceBox.textContent = lang==='fr'? tone : tone;
      reportCard.style.display = 'block';
      // ensure the report wrapper is visible (was hidden via CSS .report{display:none})
      reportSection.style.display = 'flex';
      reportSection.scrollIntoView({behavior:'smooth'});

      // Save last snapshot to localStorage
      try{
        const snapshot = {date: new Date().toISOString(), name, lang, age, death, totalCases: total, weeksLived: lived, percent, answers};
        const arr = JSON.parse(localStorage.getItem('life_mirror_snapshots') || '[]');
        arr.unshift(snapshot);
        localStorage.setItem('life_mirror_snapshots', JSON.stringify(arr.slice(0,20)));
      }catch(e){}
    }

    // Download JSON
    downloadJSON.addEventListener('click', ()=>{
      try{
        const arr = JSON.parse(localStorage.getItem('life_mirror_snapshots') || '[]');
        const blob = new Blob([JSON.stringify(arr[0] || {}, null, 2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'life_mirror_report.json'; a.click(); URL.revokeObjectURL(url);
      }catch(e){ alert(lang==='fr'? 'Impossible de t√©l√©charger le JSON.' : 'Could not download JSON.'); }
    });

    // Download PDF (capture the report card area plus preview grid snapshot)
    downloadPDF.addEventListener('click', async ()=>{
      const node = reportCard;
      if(!node) return;
      try{
        // Render a larger snapshot of previewGrid to include in PDF: create a temporary wrapper
        // use html2canvas
        const scale = Math.min(2, window.devicePixelRatio || 1);
        const canvas = await html2canvas(node, {scale, useCORS:true, backgroundColor: '#071428'});
        const imgData = canvas.toDataURL('image/png');

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({orientation:'portrait', unit:'pt', format:'a4'});
        const pageWidth = pdf.internal.pageSize.getWidth();
        const margin = 24;
        const imgWidth = pageWidth - margin*2;
        const imgHeight = canvas.height * (imgWidth / canvas.width);

        pdf.addImage(imgData, 'PNG', margin, 20, imgWidth, imgHeight);
        pdf.save('life_mirror_report.pdf');
      }catch(e){
        console.error(e);
        alert(lang==='fr'? "Erreur g√©n√©ration PDF." : "Error generating PDF.");
      }
    });

    // Restart
    restartBtn.addEventListener('click', ()=>{
      if(confirm(lang==='fr'? "Recommencer ? (les r√©ponses non sauvegard√©es seront perdues)" : "Restart? (unsaved answers will be lost)")){
        localStorage.removeItem('life_mirror_snapshots');
        location.reload();
      }
    });

    // keyboard nav
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'ArrowRight') nextBtn.click();
      if(e.key === 'ArrowLeft') prevBtn.click();
    });

    // init
    function init(){
      setLang('fr');
      renderSteps();
      renderQuestion();
      updatePreview();
      localizeStatic();
      // load previous snapshot if exists (optional)
      try{
        const arr = JSON.parse(localStorage.getItem('life_mirror_snapshots') || '[]');
        if(arr && arr[0]){ /* keep but do not auto load to avoid surprising user */ }
      }catch(e){}
    }

    init();
  })();
  </script>
</body>
</html>
